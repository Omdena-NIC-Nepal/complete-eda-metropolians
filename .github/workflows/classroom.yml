name: Grade Assignment

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  grade:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy pandas matplotlib seaborn nbformat nbconvert jupyter_client

    - name: Verify required files exist
      run: |
        if [ ! -f "climate_eda.ipynb" ]; then
          echo "Error: climate_eda.ipynb not found!"
          exit 1
        fi

    - name: Convert Jupyter Notebook to script
      run: |
        jupyter nbconvert --to script climate_eda.ipynb --output climate_eda.py
        if [ ! -f "climate_eda.py" ]; then
          echo "Error: climate_eda.py not generated!"
          exit 1
        fi

    - name: Run climate data script (if exists)
      run: |
        if [ -f "climate_data.py" ]; then
          python climate_data.py
        else
          echo "Warning: climate_data.py not found. Skipping..."
        fi

    - name: Run tests and extract grade
      run: |
        python -m unittest test_climate_eda.py | tee test_output.txt
        PASSED_TESTS=$(grep -o 'OK' test_output.txt | wc -l)
        TOTAL_TESTS=$(grep -o 'Ran [0-9]\+' test_output.txt | awk '{print $2}')
        
        if [ "$TOTAL_TESTS" -gt 0 ]; then
          GRADE=$(( (PASSED_TESTS * 100) / TOTAL_TESTS ))
        else
          GRADE=0
        fi

        echo "Grade: $GRADE/100"
        echo "GRADE=$GRADE" >> $GITHUB_ENV

    - name: Create grade summary
      run: |
        echo "## Assignment Grade: ${{ env.GRADE }}/100" > grade_summary.md

    - name: Upload grade summary
      uses: actions/upload-artifact@v4
      with:
        name: grade-summary
        path: grade_summary.md
