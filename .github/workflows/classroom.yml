name: Grade Assignment

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  grade:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy pandas matplotlib seaborn nbformat nbconvert jupyter_client jupyter ipykernel

      - name: Convert Jupyter notebook to script
        run: |
          jupyter nbconvert --to script climate_eda.ipynb --output climate_eda.py
          if [ ! -f "climate_eda.py" ]; then
            echo "Error: climate_eda.py not found!"
            exit 1
          fi

      - name: Run script and tests
        run: |
          python climate_eda.py
          python -m unittest test_climate_eda.py | tee test_output.txt
          GRADE=$(grep -o '[0-9]\+/100' test_output.txt | cut -d'/' -f1)
          echo "Grade: $GRADE/100"
          echo "GRADE=$GRADE" >> $GITHUB_ENV

      - name: Create grade summary
        run: |
          echo "## Assignment Grade: ${{ env.GRADE }}/100" > grade_summary.md

      - name: Upload grade summary
        uses: actions/upload-artifact@v4
        with:
          name: grade-summary
          path: grade_summary.md
